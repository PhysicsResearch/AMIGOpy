# .gitlab-ci.yml

stages:
  - build

variables:
  CONDA_ENV: amigo
  ENV_YML: amigo.yml

build_and_package:
  stage: build
  tags:
    - shell

  before_script:
    # 1) Update Conda itself
    - >-
      & "C:\ProgramData\Anaconda3\condabin\conda.bat" update -n base -c defaults conda --yes

    # 2) Remove any existing environment (if present)
    - >-
      & "C:\ProgramData\Anaconda3\condabin\conda.bat" env remove -n $Env:CONDA_ENV -y

    # 3) Create a fresh "amigo" environment from amigo.yml
    - >-
      & "C:\ProgramData\Anaconda3\condabin\conda.bat" env create -f $Env:ENV_YML -n $Env:CONDA_ENV --quiet

  script:
    # 4) Build your one-dir bundle with PyInstaller inside the "amigo" env
    - >-
      & "C:\ProgramData\Anaconda3\condabin\conda.bat" run -n $Env:CONDA_ENV pyinstaller Launch_ImGUI.spec

    # 5) Compile your installer with Inno Setup
    - >-
      & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "compile.iss"

    # 6) (Optional) List the Output folder to verify the artifact name
    - 'dir Output\'

  artifacts:
    # Grab whatever .exe shows up under Output\
    paths:
      - Output/*.exe
    expire_in: 1 week
