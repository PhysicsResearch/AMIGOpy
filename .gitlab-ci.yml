publish_release:
  stage: release
  tags:
    - shell
  needs:
    - job: build_and_package
      artifacts: false
  script:
    # 1) Upload the installer and capture the JSON response
    - '$uploadJson = & curl.exe --silent --header "PRIVATE-TOKEN: $env:GITLAB_TOKEN" --form "file=@C:/ci-artifacts/amigopy/mysetup.exe" "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/uploads"'
    - '$upload = $uploadJson | ConvertFrom-Json'
    - '$uploadedUrl = "$env:CI_PROJECT_URL$($upload.url)"'

    # 2) Build the Release payload
    - |
      $body = @{
        name        = "nightly-$env:CI_PIPELINE_IID"
        tag_name    = "nightly-$env:CI_PIPELINE_IID"
        description = "Automated nightly build of AMIGOpy"
        released_at = (Get-Date).ToString("o")
        assets      = @{ links = @(@{ name = "AMIGOpy Windows Installer"; url = $uploadedUrl }) }
      } | ConvertTo-Json -Depth 4

    # 3) Create/update the Release with the uploaded asset
    - '& curl.exe --silent --request POST --header "Content-Type: application/json" --header "PRIVATE-TOKEN: $env:GITLAB_TOKEN" --data $body "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/releases"'

  when: on_success