# .gitlab-ci.yml

stages:
  - build

variables:
  CONDA_ENV: amigo
  ENV_YML: amigo.yml

build_and_package:
  stage: build
  tags:
    - shell

  before_script:
    # Update Conda
    - >-
      & "C:\ProgramData\Anaconda3\condabin\conda.bat"
        update -n base -c defaults conda --yes

    # Remove old env, then recreate
    - >-
      Remove-Item -Recurse -Force "C:\ProgramData\Anaconda3\envs\$Env:CONDA_ENV" `
        -ErrorAction SilentlyContinue
    - >-
      & "C:\ProgramData\Anaconda3\condabin\conda.bat"
        env create -f $Env:ENV_YML -n $Env:CONDA_ENV --quiet

    # Ensure our persistent artifact folder exists
    - >-
      if (!(Test-Path 'C:\ci-artifacts\amigopy')) {
        New-Item -ItemType Directory -Path 'C:\ci-artifacts\amigopy' | Out-Null
      }

  script:
    # Build with PyInstaller
    - >-
      & "C:\ProgramData\Anaconda3\condabin\conda.bat"
        run -n $Env:CONDA_ENV pyinstaller Launch_ImGUI.spec

    # Package with Inno Setup
    - >-
      & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "compile.iss"

    # Copy the full dist/ and Output/ into a persistent folder
    - >-
      Copy-Item -Path dist -Destination 'C:\ci-artifacts\amigopy\dist' -Recurse -Force
    - >-
      Copy-Item -Path Output -Destination 'C:\ci-artifacts\amigopy\Output' -Recurse -Force

    # (Optional) list the persistent folder so you can see it in the job log
    - >-
      dir C:\ci-artifacts\amigopy

  artifacts:
    # We no longer need GitLab to upload the installer (itâ€™ll live on the runner)
    when: never