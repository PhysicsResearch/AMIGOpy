# .gitlab-ci.yml

stages:
  - build
  - release

variables:
  # your conda env and spec
  CONDA_ENV: amigo
  ENV_YML: amigo.yml

build_and_package:
  stage: build
  tags:
    - shell
  before_script:
    # 1) Update Conda
    - '& "C:\ProgramData\Anaconda3\condabin\conda.bat" update -n base -c defaults conda --yes'
    # 2) Remove and recreate the env
    - 'Remove-Item -Recurse -Force "C:\ProgramData\Anaconda3\envs\$Env:CONDA_ENV" -ErrorAction SilentlyContinue'
    - '& "C:\ProgramData\Anaconda3\condabin\conda.bat" env create -f $Env:ENV_YML -n $Env:CONDA_ENV --quiet'
    # 3) Ensure a persistent output folder
    - 'if (!(Test-Path "C:\ci-artifacts\amigopy")) { New-Item -ItemType Directory -Path "C:\ci-artifacts\amigopy" | Out-Null }'
  script:
    # 4) Run PyInstaller
    - '& "C:\ProgramData\Anaconda3\condabin\conda.bat" run -n amigo pyinstaller Launch_ImGUI.spec'
    # 5) Build the Inno Setup installer
    - '& "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "compile.iss"'
    # 6) Copy the installer into the persistent folder
    - 'Copy-Item -Path "Output\mysetup.exe" -Destination "C:\ci-artifacts\amigopy\mysetup.exe" -Force'
    # (optional) list it so you can see it in the job log
    - 'dir C:\ci-artifacts\amigopy'
  # no artifacts — we’ll pick it up from the runner’s disk in the next stage

publish_release:
  stage: release
  tags:
    - shell
  needs:
    - build_and_package
  script:
    # 1) Upload installer via GitLab uploads API
    - |
      $uploadResponse = Invoke-RestMethod `
        -Method Post `
        -Uri "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/uploads" `
        -Headers @{ "PRIVATE-TOKEN" = $env:GITLAB_TOKEN } `
        -Form @{ file = Get-Item "C:\ci-artifacts\amigopy\mysetup.exe" }
      $uploadedUrl = "$env:CI_PROJECT_URL$($uploadResponse.url)"

    # 2) Create (or update) the nightly release
    - |
      $releaseBody = @{
        name        = "nightly-$env:CI_PIPELINE_IID"
        tag_name    = "nightly-$env:CI_PIPELINE_IID"
        description = "Automated nightly build of AMIGOpy"
        released_at = (Get-Date).ToString("o")
        assets      = @{
          links = @(
            @{
              name = "Windows Installer"
              url  = $uploadedUrl
            }
          )
        }
      } | ConvertTo-Json -Depth 4

      Invoke-RestMethod `
        -Method Post `
        -Uri "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/releases" `
        -Headers @{ 
          "Content-Type"  = "application/json"
          "PRIVATE-TOKEN" = $env:GITLAB_TOKEN 
        } `
        -Body $releaseBody

  when: on_success